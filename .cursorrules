# Cursor Rules for Common Pool Resource Game

## Virtual Environment

- Always run the agent in the conda base environment
- Activate the environment using: `/Users/shayyahal/miniconda3/bin/activate base` or `.venv` directly under the root folder.
- Ensure all Python commands and scripts are executed within this activated environment
- Always find the most relevant virtual environment to use for the project

## Logging Guidelines

### Always Use Logs, Never Print
- **NEVER** use `print()` statements in production code
- **ALWAYS** use the logger from `cpr_game.logger_setup import get_logger`
- Replace all `print()` calls with appropriate logger calls

### Log Level Usage

1. **DEBUG** - Use for:
   - Flow steps and detailed execution traces
   - API calls and their details (tokens, latency, cost)
   - Internal state changes and intermediate operations
   - Detailed diagnostic information

2. **INFO** - Use for:
   - Main events only (game start/end, experiment start/end, major milestones)
   - High-level progress updates
   - Important state changes that users should know about

3. **WARNING** - Use for:
   - Unexpected or undesired behavior
   - Recoverable errors or fallback scenarios
   - Configuration issues or missing optional features
   - Anything that might indicate a problem but doesn't stop execution

4. **ERROR** - Use for:
   - Actual errors that prevent normal operation
   - Exceptions and failures
   - Critical issues that require attention

### Logging Configuration

The logging system uses separate file handlers for each log level:
- `logs/debug.log` - DEBUG level and above
- `logs/info.log` - INFO level and above
- `logs/warning.log` - WARNING level and above
- `logs/error.log` - ERROR level and above
- `stdout` - All levels (DEBUG and above, configurable via STDOUT_LOG_LEVEL env var)

Each file handler captures its level and all levels above it.

### Third-Party Library Loggers

Third-party libraries (httpx, urllib3, requests, openai, etc.) are automatically configured
to WARNING level to suppress verbose HTTP request/response logging. These are implementation
details, not application-level events.

**IMPORTANT**: HTTP request logs (like "HTTP Request: POST https://...") are NOT INFO level.
They are low-level implementation details and should be suppressed or logged at DEBUG/WARNING.
If you see third-party libraries logging at INFO, configure their loggers in `logger_setup.py`.

### Examples

```python
from cpr_game.logger_setup import get_logger

logger = get_logger(__name__)

# Flow step - use DEBUG
logger.debug("Processing round 5...")
logger.debug(f"API call successful: {tokens} tokens, {latency:.2f}s")

# Main event - use INFO
logger.info("Game started: game_123")
logger.info("Experiment completed: 10 games successful")

# Unexpected behavior - use WARNING
logger.warning("Could not claim experiment (already claimed)")
logger.warning("Database connection retry failed, will retry")

# Error - use ERROR
logger.error("Failed to initialize database", exc_info=True)
logger.error(f"API call failed: {error}")
```

## Error Handling Rules

### Never Implement Silent Errors or Warnings

- **NEVER EVER** implement silent errors or warnings, unless the user explicitly asked to suppress this specific error
- **NEVER** use `try-except` blocks without reraising the exception
- **NEVER** simply print or log an error and then `pass` or continue silently
- **ALWAYS** propagate errors unless you have a specific, intentional reason to handle them
- If you catch an exception, you must either:
  1. Reraise it (using `raise` or `raise ... from ...`)
  2. Transform it into a more appropriate exception and raise that
  3. Handle it completely and intentionally (only if the user explicitly requested this behavior)

### Examples of FORBIDDEN Patterns

```python
# ❌ FORBIDDEN: Silent error suppression
try:
    risky_operation()
except Exception:
    pass  # NEVER DO THIS

# ❌ FORBIDDEN: Log and ignore
try:
    risky_operation()
except Exception as e:
    logger.error(f"Error: {e}")  # Logging alone is not enough
    pass  # NEVER DO THIS

# ❌ FORBIDDEN: Catch and continue silently
try:
    risky_operation()
except Exception:
    logger.warning("Operation failed, continuing...")  # Silent warning
    continue  # NEVER DO THIS without explicit user request
```

### Examples of CORRECT Patterns

```python
# ✅ CORRECT: Reraise the exception
try:
    risky_operation()
except Exception:
    raise  # Always reraise unless explicitly handling

# ✅ CORRECT: Transform and reraise
try:
    risky_operation()
except ValueError as e:
    raise CustomError("Operation failed") from e

# ✅ CORRECT: Handle completely (only if user explicitly requested)
try:
    optional_operation()
except Exception as e:
    logger.warning(f"Optional operation failed: {e}")
    # Only acceptable if user explicitly asked to suppress this error
    return default_value
```

